<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>📈 تنبؤ الرياح والحرارة</title>
  <!-- Tailwind via CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", "Helvetica Neue", Arial; }
    .fade-in { animation: fade .3s ease-in-out; }
    @keyframes fade { from {opacity:0; transform: translateY(6px)} to {opacity:1; transform: translateY(0)} }
    .lang-select { border-radius: 9999px; padding: 6px 10px; border: 1px solid #e5e7eb; background: white; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <h1 class="text-xl font-bold" id="title-ar">📈 تنبؤ الرياح والحرارة</h1>
        <h1 class="text-xl font-bold hidden" id="title-en">📈 Wind & Temperature Forecast</h1>
      </div>
      <div class="text-sm text-gray-600 flex gap-2 items-center">
        <select id="langSelect" class="lang-select">
          <option value="ar" selected>العربية</option>
          <option value="en">English</option>
        </select>
        <button id="locBtn" class="px-3 py-1.5 rounded-2xl bg-blue-600 text-white hover:bg-blue-700">استخدم موقعي</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4">
    <section id="steps" class="mb-4 bg-yellow-50 border border-yellow-200 text-yellow-900 p-3 rounded-xl text-sm">
      الخطوات: 1) اختر الإحداثيات أو استخدم موقعك، 2) اضغط "تحديث التنبؤ"، 3) تصفح بيانات اليوم.
    </section>
    <div class="mb-4 flex flex-wrap gap-2 items-center">
      <label class="text-sm" id="latLbl">خط العرض:</label>
      <input id="latInput" type="number" step="any" class="border px-2 py-1 rounded" style="width:120px" />
      <label class="text-sm" id="lonLbl">خط الطول:</label>
      <input id="lonInput" type="number" step="any" class="border px-2 py-1 rounded" style="width:120px" />
      <button id="fetchBtn" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">تحديث التنبؤ</button>
    </div>
    <div id="status" class="hidden mb-4 p-3 rounded-xl text-sm"></div>
    <div id="cards" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </main>

  <script>
    const fetchBtn = document.getElementById('fetchBtn');
    const locBtn   = document.getElementById('locBtn');
    const langSelect = document.getElementById('langSelect');
    const statusEl = document.getElementById('status');
    const cardsEl  = document.getElementById('cards');
    const latInput = document.getElementById('latInput');
    const lonInput = document.getElementById('lonInput');

    // Default location (Ras Ghareb) if nothing provided
    const DEFAULT_LOCATION = { lat: 28.35831, lon: 33.07829, name: 'رأس غارب' };

    /**
     * Display a status message.
     * @param {string} msg The message to display
     * @param {string} type One of 'info', 'ok' or 'error'
     */
    function setStatus(msg, type='info') {
      statusEl.classList.remove('hidden');
      const base='mb-4 p-3 rounded-xl text-sm';
      const styles = type==='error' ? 'bg-red-50 border border-red-200 text-red-800'
                   : type==='ok'   ? 'bg-emerald-50 border border-emerald-200 text-emerald-900'
                                    : 'bg-blue-50 border border-blue-200 text-blue-900';
      statusEl.className = `${base} ${styles} fade-in`;
      statusEl.textContent = msg;
    }

    /** Format a date string into a readable label */
    function formatDate(iso, locale='ar-EG') {
      const d = new Date(iso + 'T00:00:00');
      return d.toLocaleDateString(locale, { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    }

    /** Compute hour indices for a given day index */
    function hoursForDay(index, hourlyTimes) {
      const allDays = hourlyTimes.map(t => t.slice(0, 10));
      const uniqueDays = [...new Set(allDays)];
      const targetDay = uniqueDays[index];
      const idx = [];
      allDays.forEach((d,i)=>{ if(d === targetDay) idx.push(i); });
      return idx;
    }

    /** Change language and update UI labels */
    function updateLanguage(lang) {
      const isEN = lang === 'en';
      document.documentElement.dir = isEN ? 'ltr' : 'rtl';
      document.getElementById('title-ar').classList.toggle('hidden', isEN);
      document.getElementById('title-en').classList.toggle('hidden', !isEN);
      // Update labels
      document.getElementById('steps').textContent = isEN
        ? 'Steps: 1) choose coordinates or use your location, 2) click "Update forecast", 3) explore the daily data.'
        : 'الخطوات: 1) اخت\u{0631} الإحداثيات أو استخدم موقعك، 2) اضغط \"\u062a\u062d\u062f\u064a\u062b التنب\u0624\"\u060c 3) تصفح بيانات اليوم.';
      document.getElementById('latLbl').textContent = isEN ? 'Latitude:' : 'خط العرض:';
      document.getElementById('lonLbl').textContent = isEN ? 'Longitude:' : 'خط الطول:';
      fetchBtn.textContent = isEN ? 'Update forecast' : 'تحديث التنبؤ';
      locBtn.textContent  = isEN ? 'Use my location' : 'استخدم موقعي';
    }

    langSelect.addEventListener('change', () => {
      updateLanguage(langSelect.value);
    });

    // Use browser geolocation to fill lat/lon inputs
    locBtn.addEventListener('click', () => {
      if (!navigator.geolocation) {
        setStatus(langSelect.value === 'en' ? 'Geolocation not supported' : 'المتصفح لا يدعم تحديد الموقع', 'error');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          latInput.value = pos.coords.latitude.toFixed(4);
          lonInput.value = pos.coords.longitude.toFixed(4);
        },
        (err) => {
          console.error(err);
          setStatus(langSelect.value === 'en' ? 'Unable to get your location' : 'تعذر الحصول على موقعك', 'error');
        }
      );
    });

    // Handle forecast fetch
    fetchBtn.addEventListener('click', async () => {
      const lat = latInput.value || DEFAULT_LOCATION.lat;
      const lon = lonInput.value || DEFAULT_LOCATION.lon;
      setStatus(langSelect.value === 'en' ? 'Fetching forecast...' : 'جاري جلب التنبؤ...');
      cardsEl.innerHTML = '';
      try {
        const resp = await fetch(`/api/forecast?lat=${lat}&lon=${lon}`);
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        // Build cards
        buildCards(data);
        setStatus(langSelect.value === 'en' ? 'Forecast updated.' : 'تم تحديث التنبؤ.', 'ok');
      } catch (err) {
        console.error(err);
        setStatus(langSelect.value === 'en' ? 'Error fetching forecast' : 'خطأ في جلب التنبؤ', 'error');
      }
    });

    /**
     * Render daily forecast cards
     * @param {object} data The forecast JSON from the server
     */
    function buildCards(data) {
      const isEN = langSelect.value === 'en';
      const days = data.daily.time;
      const tmax = data.daily.temperature_2m_max;
      const tmin = data.daily.temperature_2m_min;
      const wmax = data.daily.wind_speed_10m_max;
      const wmin = data.daily.wind_speed_10m_min;
      const hourlyTimes = data.hourly.time;
      const hourlyWind = data.hourly.wind_speed_10m;
      cardsEl.innerHTML = '';
      days.forEach((dayISO, idx) => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-2xl shadow p-4 fade-in flex flex-col justify-between';
        const title = document.createElement('h3');
        title.className = 'text-lg font-bold';
        title.textContent = formatDate(dayISO, isEN ? 'en-GB' : 'ar-EG');
        const subtitle = document.createElement('div');
        subtitle.className = 'text-sm text-gray-500';
        subtitle.textContent = `${isEN ? 'Max' : 'العظى'} ${tmax[idx].toFixed(1)}°C / ${isEN ? 'Min' : 'الصغرى'} ${tmin[idx].toFixed(1)}°C`;
        const windline = document.createElement('div');
        windline.className = 'text-sm text-gray-500';
        windline.textContent = `${isEN ? 'Wind' : 'الرياح'}: ${wmax[idx].toFixed(1)} / ${wmin[idx].toFixed(1)} m/s`;
        const prodDiv = document.createElement('div');
        prodDiv.className = 'mt-2 text-sm';
        prodDiv.textContent = isEN ? 'Expected production: --' : 'الإنتاج المتوقع: --';
        // Button to compute expected production
        const btn = document.createElement('button');
        btn.className = 'mt-3 px-3 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700 text-sm';
        btn.textContent = isEN ? 'Compute production' : 'احسب الإنتاج';
        btn.addEventListener('click', async () => {
          btn.disabled = true;
          btn.textContent = isEN ? 'Calculating...' : 'جارِ الحساب...';
          // Get hourly indices for this day
          const idxs = hoursForDay(idx, hourlyTimes);
          const speeds = idxs.map(i => hourlyWind[i]);
          try {
            const resp = await fetch(`/api/production?windSpeeds=${speeds.join(',')}`);
            if (!resp.ok) throw new Error(await resp.text());
            const json = await resp.json();
            const productions = json.productions;
            // Sum of all hours
            const sum = productions.reduce((a,b) => a + b, 0);
            prodDiv.textContent = `${isEN ? 'Expected production' : 'الإنتاج المتوقع'}: ${sum.toFixed(2)} MW`;
          } catch (err) {
            console.error(err);
            prodDiv.textContent = isEN ? 'Error computing production' : 'خطأ في حساب الإنتاج';
          } finally {
            btn.disabled = false;
            btn.textContent = isEN ? 'Compute production' : 'احسب الإنتاج';
          }
        });
        card.appendChild(title);
        card.appendChild(subtitle);
        card.appendChild(windline);
        card.appendChild(prodDiv);
        card.appendChild(btn);
        cardsEl.appendChild(card);
      });
    }

    // Initialize default language and prefill coordinates with default values
    updateLanguage(langSelect.value);
    latInput.value = DEFAULT_LOCATION.lat;
    lonInput.value = DEFAULT_LOCATION.lon;
  </script>
</body>
</html>
